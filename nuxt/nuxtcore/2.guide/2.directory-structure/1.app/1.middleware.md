---
title: "middleware"
description: "Nuxt provides middleware to run code before navigating to a particular route."
head.title: "middleware/"
navigation.icon: i-lucide-folder
---

Nuxt cung cấp một framework **route middleware** có thể tùy chỉnh mà bạn có thể sử dụng trong toàn bộ ứng dụng của mình, lý tưởng để trích xuất code mà bạn muốn chạy trước khi điều hướng đến một route cụ thể.

Có ba loại route middleware:

1. Anonymous (hoặc inline) route middleware được định nghĩa trực tiếp trong trang.
2. Named route middleware, được đặt trong `middleware/` và được tải tự động qua asynchronous import khi được sử dụng trên một trang.
3. Global route middleware, được đặt trong `middleware/` với hậu tố `.global` và được chạy trên mọi thay đổi route.

Hai loại route middleware đầu tiên có thể được định nghĩa trong [`definePageMeta`](/docs/api/utils/define-page-meta).

::note
Tên của middleware được chuẩn hóa thành kebab-case: `myMiddleware` trở thành `my-middleware`.
::

::note
Route middleware chạy trong phần Vue của ứng dụng Nuxt của bạn. Mặc dù có tên tương tự, chúng hoàn toàn khác với [server middleware](/docs/guide/directory-structure/server#server-middleware), được chạy trong phần Nitro server của ứng dụng của bạn.
::

:video-accordion{title="Watch a video from Vue School on all 3 kinds of middleware" videoId="761471577" platform="vimeo"}

## Usage

Route middleware là navigation guards nhận route hiện tại và route tiếp theo làm đối số.

```ts twoslash [middleware/my-middleware.ts]
export default defineNuxtRouteMiddleware((to, from) => {
  if (to.params.id === '1') {
    return abortNavigation()
  }
  // In a real app you would probably not redirect every route to `/`
  // however it is important to check `to.path` before redirecting or you
  // might get an infinite redirect loop
  if (to.path !== '/') {
    return navigateTo('/')
  }
})
```

Nuxt cung cấp hai helper có sẵn toàn cục có thể được trả về trực tiếp từ middleware.

1. [`navigateTo`](/docs/api/utils/navigate-to) - Chuyển hướng đến route đã cho
2. [`abortNavigation`](/docs/api/utils/abort-navigation) - Hủy bỏ navigation, với thông báo lỗi tùy chọn.

Không giống như [navigation guards](https://router.vuejs.org/guide/advanced/navigation-guards.html#global-before-guards) từ `vue-router`, đối số thứ ba `next()` không được truyền, và **chuyển hướng hoặc hủy bỏ route được xử lý bằng cách trả về một giá trị từ middleware**.

Các giá trị trả về có thể là:

* không có gì (một `return` đơn giản hoặc không return) - không chặn navigation và sẽ chuyển đến hàm middleware tiếp theo, nếu có, hoặc hoàn thành navigation route
* `return navigateTo('/')` - chuyển hướng đến path đã cho và sẽ đặt mã chuyển hướng thành [`302` Found](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/302) nếu chuyển hướng xảy ra ở phía server
* `return navigateTo('/', { redirectCode: 301 })` - chuyển hướng đến path đã cho và sẽ đặt mã chuyển hướng thành [`301` Moved Permanently](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/301) nếu chuyển hướng xảy ra ở phía server
* `return abortNavigation()` - dừng navigation hiện tại
* `return abortNavigation(error)` - từ chối navigation hiện tại với lỗi

:read-more{to="/docs/api/utils/navigate-to"}
:read-more{to="/docs/api/utils/abort-navigation"}

::important
Chúng tôi khuyến nghị sử dụng các hàm helper ở trên để thực hiện chuyển hướng hoặc dừng navigation. Các giá trị trả về có thể khác được mô tả trong [vue-router docs](https://router.vuejs.org/guide/advanced/navigation-guards.html#global-before-guards) có thể hoạt động nhưng có thể có thay đổi breaking trong tương lai.
::

## Middleware Order

Middleware chạy theo thứ tự sau:

1. Global Middleware
2. Thứ tự middleware được định nghĩa trong trang (nếu có nhiều middleware được khai báo với cú pháp array)

Ví dụ, giả sử bạn có middleware và component sau:

```bash [middleware/ directory]
-| middleware/
---| analytics.global.ts
---| setup.global.ts
---| auth.ts
```

```vue twoslash [pages/profile.vue]
<script setup lang="ts">
definePageMeta({
  middleware: [
    function (to, from) {
      // Custom inline middleware
    },
    'auth',
  ],
});
</script>
```

Bạn có thể mong đợi middleware được chạy theo thứ tự sau:

1. `analytics.global.ts`
2. `setup.global.ts`
3. Custom inline middleware
4. `auth.ts`

### Ordering Global Middleware

Theo mặc định, global middleware được thực thi theo thứ tự alphabet dựa trên tên file.

Tuy nhiên, có thể có lúc bạn muốn định nghĩa thứ tự cụ thể. Ví dụ, trong kịch bản cuối cùng, `setup.global.ts` có thể cần chạy trước `analytics.global.ts`. Trong trường hợp đó, chúng tôi khuyến nghị thêm tiền tố global middleware với 'alphabetical' numbering.

```bash [Directory structure]
-| middleware/
---| 01.setup.global.ts
---| 02.analytics.global.ts
---| auth.ts
```

::note
Trong trường hợp bạn mới với 'alphabetical' numbering, hãy nhớ rằng tên file được sắp xếp như string, không phải như giá trị số. Ví dụ, `10.new.global.ts` sẽ đến trước `2.new.global.ts`. Đây là lý do ví dụ thêm `0` trước số có một chữ số.
::

## When Middleware Runs

Nếu site của bạn được server-rendered hoặc generated, middleware cho trang đầu tiên sẽ được thực thi cả khi trang được render và sau đó lại trên client. Điều này có thể cần thiết nếu middleware của bạn cần môi trường browser, chẳng hạn như nếu bạn có site generated, cache responses một cách tích cực, hoặc muốn đọc giá trị từ local storage.

Tuy nhiên, nếu bạn muốn tránh hành vi này bạn có thể làm như sau:

```ts twoslash [middleware/example.ts]
export default defineNuxtRouteMiddleware(to => {
  // skip middleware on server
  if (import.meta.server) return
  // skip middleware on client side entirely
  if (import.meta.client) return
  // or only skip middleware on initial client load
  const nuxtApp = useNuxtApp()
  if (import.meta.client && nuxtApp.isHydrating && nuxtApp.payload.serverRendered) return
})
```

Điều này đúng ngay cả khi bạn throw lỗi trong middleware của bạn trên server, và trang lỗi được render. Middleware vẫn sẽ chạy lại trong browser.

::note
Render trang lỗi là một page load hoàn toàn riêng biệt, nghĩa là bất kỳ middleware đã đăng ký nào sẽ chạy lại. Bạn có thể sử dụng [`useError`](/docs/getting-started/error-handling#useerror) trong middleware để kiểm tra xem lỗi có đang được xử lý hay không.
::

## Adding Middleware Dynamically

Có thể thêm global hoặc named route middleware theo cách thủ công bằng hàm helper [`addRouteMiddleware()`](/docs/api/utils/add-route-middleware), chẳng hạn như từ trong plugin.

```ts twoslash
export default defineNuxtPlugin(() => {
  addRouteMiddleware('global-test', () => {
    console.log('this global middleware was added in a plugin and will be run on every route change')
  }, { global: true })

  addRouteMiddleware('named-test', () => {
    console.log('this named middleware was added in a plugin and would override any existing middleware of the same name')
  })
})
```

## Example

```bash [Directory Structure]
-| middleware/
---| auth.ts
```

Trong file trang của bạn, bạn có thể tham chiếu route middleware này:

```vue twoslash
<script setup lang="ts">
definePageMeta({
  middleware: ["auth"]
  // or middleware: 'auth'
})
</script>
```

Bây giờ, trước khi navigation đến trang đó có thể hoàn thành, route middleware `auth` sẽ được chạy.

:link-example{to="/docs/examples/routing/middleware"}

## Setting Middleware at Build Time

Thay vì sử dụng `definePageMeta` trên mỗi trang, bạn có thể thêm named route middleware trong hook `pages:extend`.

```ts twoslash [nuxt.config.ts]
import type { NuxtPage } from 'nuxt/schema'

export default defineNuxtConfig({
  hooks: {
    'pages:extend' (pages) {
      function setMiddleware (pages: NuxtPage[]) {
        for (const page of pages) {
          if (/* some condition */ true) {
            page.meta ||= {}
            // Note that this will override any middleware set in `definePageMeta` in the page
            page.meta.middleware = ['named']
          }
          if (page.children) {
            setMiddleware(page.children)
          }
        }
      }
      setMiddleware(pages)
    }
  }
})
```
