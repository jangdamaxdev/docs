---
title: 'Sessions and Authentication'
description: "Authentication is an extremely common requirement in web apps. This recipe will show you how to implement basic user registration and authentication in your Nuxt app."
---

## Introduction

Trong recipe này chúng ta sẽ be setting up authentication trong một full-stack Nuxt app using [Nuxt Auth Utils](https://github.com/Atinux/nuxt-auth-utils) which provides convenient utilities cho managing client-side và server-side session data.

Module này uses secured & sealed cookies để store session data, so bạn don't need để setup một database để store session data.

## Install nuxt-auth-utils

Install `nuxt-auth-utils` module using `nuxt` CLI.

```bash [Terminal]
npx nuxt module add auth-utils
```

::callout
Command này sẽ install `nuxt-auth-utils` như dependency và push nó vào `modules` section của `nuxt.config.ts` của chúng ta.
::

## Cookie Encryption Key

As `nuxt-auth-utils` uses sealed cookies để store session data, session cookies are encrypted using một secret key từ `NUXT_SESSION_PASSWORD` environment variable.

::note
Nếu not set, environment variable này sẽ be added đến `.env` của bạn automatically khi running trong development mode.
::

```ini [.env]
NUXT_SESSION_PASSWORD=a-random-password-with-at-least-32-characters
```

::important
Bạn sẽ need để add environment variable này đến production environment của bạn trước khi deploying.
::

## Login API Route

Cho recipe này, chúng ta sẽ create một simple API route để sign-in một user based trên static data.

Hãy create một `/api/login` API route that will accept một POST request với email và password trong request body.

```ts [server/api/login.post.ts]
import { z } from 'zod'

const bodySchema = z.object({
  email: z.string().email(),
  password: z.string().min(8)
})

export default defineEventHandler(async (event) => {
  const { email, password } = await readValidatedBody(event, bodySchema)

  if (email === 'admin@admin.com' && password === 'iamtheadmin') {
    // set the user session in the cookie
    // this server util is auto-imported by the auth-utils module
    await setUserSession(event, {
      user: {
        name: 'John Doe'
      }
    })
    return {}
  }
  throw createError({
    statusCode: 401,
    message: 'Bad credentials'
  })
})
```

::callout
Make sure để install `zod` dependency trong project của bạn (`npm i zod`).
::

::tip{to="https://github.com/atinux/nuxt-auth-utils#server-utils"}
Read more về `setUserSession` server helper exposed bởi `nuxt-auth-utils`.
::

## Login Page

Module này exposes một Vue composable để know if một user is authenticated trong application của chúng ta:

```vue
<script setup>
const { loggedIn, session, user, clear, fetch } = useUserSession()
</script>
```

Hãy create một login page với một form để submit login data đến `/api/login` route của chúng ta.

```vue [pages/login.vue]
<script setup lang="ts">
const { loggedIn, user, fetch: refreshSession } = useUserSession()
const credentials = reactive({
  email: '',
  password: '',
})
async function login() {
  $fetch('/api/login', {
    method: 'POST',
    body: credentials
  })
  .then(async () => {
    // Refresh the session on client-side and redirect to the home page
    await refreshSession()
    await navigateTo('/')
  })
  .catch(() => alert('Bad credentials'))
}
</script>

<template>
  <form @submit.prevent="login">
    <input v-model="credentials.email" type="email" placeholder="Email" />
    <input v-model="credentials.password" type="password" placeholder="Password" />
    <button type="submit">Login</button>
  </form>
</template>
```

## Protect API Routes

Protecting server routes is key để making sure data của bạn is safe. Client-side middleware is helpful cho user, nhưng without server-side protection data của bạn can still be accessed. Nó is critical để protect bất kỳ routes nào với sensitive data, chúng ta should return một 401 error nếu user is not logged in trên those.

`auth-utils` module provides `requireUserSession` utility function để help make sure users are logged in và have một active session.

Hãy create một example của một `/api/user/stats` route that only authenticated users can access.

```ts [server/api/user/stats.get.ts]
export default defineEventHandler(async (event) => {
  // make sure the user is logged in
  // This will throw a 401 error if the request doesn't come from a valid user session
  const { user } = await requireUserSession(event)

  // TODO: Fetch some stats based on the user

  return {}
});
```

## Protect App Routes

Data của chúng ta is safe với server-side route trong place, nhưng without doing anything else, unauthenticated users would probably get một số odd data khi trying để access `/users` page. Chúng ta should create một [client-side middleware](https://nuxt.com/docs/guide/directory-structure/middleware) để protect route trên client side và redirect users đến login page.

`nuxt-auth-utils` provides một convenient `useUserSession` composable which chúng ta sẽ use để check if user is logged in, và redirect chúng nếu not.

Chúng ta sẽ create một middleware trong `/middleware` directory. Unlike trên server, client-side middleware is not automatically applied đến tất cả endpoints, và chúng ta sẽ need để specify where chúng ta want nó applied.

```typescript [middleware/authenticated.ts]
export default defineNuxtRouteMiddleware(() => {
  const { loggedIn } = useUserSession()

  // redirect the user to the login screen if they're not authenticated
  if (!loggedIn.value) {
    return navigateTo('/login')
  }
})
```

## Home Page

Bây giờ chúng ta have app middleware của chúng ta để protect routes của chúng ta, chúng ta có thể use nó trên home page của chúng ta that display authenticated user information của chúng ta. Nếu user is not authenticated, họ will be redirected đến login page.

Chúng ta sẽ use [`definePageMeta`](/docs/api/utils/define-page-meta) để apply middleware đến route that chúng ta want để protect.

```vue [pages/index.vue]
<script setup lang="ts">
definePageMeta({
  middleware: ['authenticated'],
})
  
const { user, clear: clearSession } = useUserSession()

async function logout() {
  await clearSession()
  await navigateTo('/login')
}
</script>

<template>
  <div>
    <h1>Welcome {{ user.name }}</h1>
    <button @click="logout">Logout</button>
  </div>
</template>
```

Chúng ta also added một logout button để clear session và redirect user đến login page.

## Conclusion

Chúng ta đã successfully set up một very basic user authentication và session management trong Nuxt app của chúng ta. Chúng ta also protected sensitive routes trên server và client side để ensure rằng only authenticated users can access chúng.

As next steps, bạn can:
- Add authentication using [20+ supported OAuth providers](https://github.com/atinux/nuxt-auth-utils?tab=readme-ov-file#supported-oauth-providers)
- Add một database để store users, see [Nitro SQL Database](https://nitro.build/guide/database) hoặc [NuxtHub SQL Database](https://hub.nuxt.com/docs/features/database)
- Let user signup với email & password using [password hashing](https://github.com/atinux/nuxt-auth-utils?tab=readme-ov-file#password-hashing)
- Add support cho [WebAuthn / Passkeys](https://github.com/atinux/nuxt-auth-utils?tab=readme-ov-file#webauthn-passkey)

Checkout open source [atidone repository](https://github.com/atinux/atidone) cho một full example của một Nuxt app với OAuth authentication, database và CRUD operations.
